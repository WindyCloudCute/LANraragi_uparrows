#!/bin/sh



#Ensure LRR folder is writable
chown root /home/dezhao/lanraragi
chmod u+rwx /home/dezhao/lanraragi

#Crash with an error if content folder doesn't exist
if [ ! -d "/home/dezhao/lanraragi/content" ]; then
  echo "Content folder doesn't exist! Please ensure your Docker mappings are correct."
  exit 1
fi

#Ensure database is writable
chown -R root /home/dezhao/lanraragi/database
chmod -R 777 /home/dezhao/lanraragi/database

#Ensure thumbnail folder is writable
chmod -R 744 /home/dezhao/lanraragi/content/thumb
find /home/dezhao/lanraragi/content/thumb -type f -exec chmod u+rw  {} \;
find /home/dezhao/lanraragi/content/thumb -type d -exec chmod u+rwx {} \;

#Ensure log folder is writable
mkdir /home/dezhao/lanraragi/log
chown -R root /home/dezhao/lanraragi/log
chmod u+rwx /home/dezhao/lanraragi/log

#Ensure temp folder is writable
mkdir /home/dezhao/lanraragi/public/temp
chown -R root /home/dezhao/lanraragi/public/temp
chmod u+rwx /home/dezhao/lanraragi/public/temp

#Remove mojo, minion and shinobu pid files
rm /home/dezhao/lanraragi/public/temp/server.pid
rm /home/dezhao/lanraragi/public/temp/shinobu.pid
rm /home/dezhao/lanraragi/public/temp/minion.pid

# https://redis.io/topics/faq#background-saving-fails-with-a-fork-error-under-linux-even-if-i-have-a-lot-of-free-ram
OVERCOMMIT=$(cat /proc/sys/vm/overcommit_memory)
if [ $OVERCOMMIT -eq 0 ]
then
        echo "WARNING: overcommit_memory is set to 0! This might lead to background saving errors if your database is too large."
            echo "Please check https://redis.io/topics/faq#background-saving-fails-with-a-fork-error-under-linux-even-if-i-have-a-lot-of-free-ram for details."
fi
